apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
    labels:
        machineconfiguration.openshift.io/role: worker-rt
    name: 12-rt-pre-boot-worker-tuning
spec:
    #kernelArguments:
    #    - 'non_iso_cpumask=00000005'
    #    - 'reserved_cpus'=0-2'
    config:
        ignition:
            config: {}
            security:
                tls: {}
            timeouts: {}
            version: 2.2.0
        networkd: {}
        passwd: {}
        storage:
            files:
                - filesystem: root
                  path: /usr/local/bin/pre-boot-tuning.sh
                  mode: 0700
                  contents:
                      source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpyZXNlcnZlZF9jcHVzPSIiCm5vbl9pc29fY3B1bWFzaz0iIgpjcHVfYWZmaW5pdHk9IiIKCmdldF9yZXNlcnZlZF9jb3JlcygpIHsKICAgIGNvcmVzPSgpCiAgICB3aGlsZSByZWFkIHBhcnQ7IGRvCiAgICAgICAgaWYgW1sgJHBhcnQgPX4gLSBdXTsgdGhlbgogICAgICAgICAgICBjb3Jlcys9KCQoc2VxICR7cGFydC8tLyB9KSkKICAgICAgICBlbHNlCiAgICAgICAgICAgIGNvcmVzKz0oJHBhcnQpCiAgICAgICAgZmkKICAgIGRvbmUgPCA8KCBlY2hvICRyZXNlcnZlZF9jcHVzIHwgdHIgJywnICdcbicgKQp9CgojICQxIC0gMCBmb3IgaXJxIGJhbGFuY2UgYmFubmVkIGNwdXMgbWFza2luZyAsIDEgZm9yIG5vbiBpc29sYXRlZCBjcHVzIG1hc2tpbmcKZ2V0X2NwdV9tYXNrKCkgewogICAgaWYgWyAiJDEiID0gIjEiIF07IHRoZW4KICAgICAgICBtYXNrPSggMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwICkKICAgIGVsc2UKICAgICAgICBtYXNrPSggMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxICkgCiAgICBmaSAgICAKICAgIGdldF9yZXNlcnZlZF9jb3JlcwogICAgZm9yIGNvcmUgaW4gJHtjb3Jlc1sqXX07IGRvCiAgICAgICAgZWNobyAkY29yZQogICAgICAgIG1hc2tbJGNvcmVdPSQxCiAgICBkb25lCiAgICBjcHVtYXNrQmluYXJ5PWBlY2hvICR7bWFza1tAXX18IHJldmAKICAgIGNwdW1hc2tCaW5hcnk9JHtjcHVtYXNrQmluYXJ5Ly9bWzpzcGFjZTpdXS99CiAgICBub25faXNvX2NwdW1hc2s9YHByaW50ZiAnJTA4eFxuJyAiJCgoMiMkY3B1bWFza0JpbmFyeSkpImAKfQoKZ2V0X2NwdV9hZmZpbml0eSgpIHsKICAgIGNwdV9hZmZpbml0eT0iIgogICAgZ2V0X3Jlc2VydmVkX2NvcmVzCiAgICBmb3IgY29yZSBpbiAke2NvcmVzWypdfTsgZG8KICAgICAgICBjcHVfYWZmaW5pdHkrPSIgJGNvcmUiCiAgICBkb25lCiAgICBlY2hvICJDUFUgQWZmaW5pdHkgc2V0IHRvICRjcHVfYWZmaW5pdHkiCn0KCiMgVE9ETzogaW1wcm92ZSBjaGVjayBmb3IgYXBwbGllZCBjb25maWd1cmF0aW9uCmlmIGdyZXAgLUZ4cSAiQ1BVQWZmaW5pdHkiICIvZXRjL3N5c3RlbWQvc3lzdGVtLmNvbmYiOyB0aGVuCiAgICBlY2hvICJQcmUgYm9vdCB0dW5pbmcgY29uZmlndXJhdGlvbiBhbHJlYWR5IGFwcGxpZWQiCiAgICBlY2hvICJTZXR0aW5nIGtlcm5lbCByY3VvKiB0aHJlYWRzIHRvIHRoZSBob3VzZWtlZXBpbmcgY3B1cyIKICAgIGdldF9jcHVfbWFzayAxCiAgICBwZ3JlcCByY3VvKiB8IHdoaWxlIHJlYWQgbGluZTsgZG8gdGFza3NldCAtcCBub25faXNvX2NwdW1hc2sgJGxpbmU7IGRvbmUKZWxzZQogICAgaWYgc3lzY3RsIC1hIHwgZ3JlcCAtcSByZXNlcnZlZF9jcHVzOyB0aGVuCiAgICAgICAgcmVzZXJ2ZWRfY3B1cz0iJChzeXNjdGwgLXEgLWUgLW4gcmVzZXJ2ZWRfY3B1cykiCiAgICBlbHNlCiAgICAgICAgZWNobyAiQ291bGQgbm90IHJldHJpdmUgcmVzZXJ2ZWRfY3B1cyBmcm9tIGthcmdzIgogICAgICAgIGV4aXQgMSAgICAKICAgIGZpCgogICAgIyBDbGVhbiB1cAogICAgcm0gLXJmIGluaXRyZAogICAgcm0gaXNvX2luaXRyZC5pbWcKICAgICMgQ3JlYXRlIGluaXRyZCBpbWFnZQogICAgbWtkaXIgaW5pdHJkCiAgICBjZCBpbml0cmQKICAgIG1rZGlyIC1wIC4vdXNyL2xpYi9kcmFjdXQvaG9va3MvcHJlLXVkZXYvCiAgICBta2RpciAtcCAuL2V0Yy9zeXN0ZW1kLwogICAgbWtkaXIgLXAgLi9ldGMvc3lzY29uZmlnLwogICAgdG91Y2ggLi9ldGMvc3lzdGVtZC9zeXN0ZW0uY29uZgogICAgdG91Y2ggLi9ldGMvc3lzY29uZmlnL2lycWJhbGFuY2UKICAgIHRvdWNoIC4vdXNyL2xpYi9kcmFjdXQvaG9va3MvcHJlLXVkZXYvMDAtdHVuZWQtcHJlLXVkZXYuc2gKICAgIGNobW9kICt4IC4vdXNyL2xpYi9kcmFjdXQvaG9va3MvcHJlLXVkZXYvMDAtdHVuZWQtcHJlLXVkZXYuc2gKCiAgICBnZXRfY3B1X21hc2sgMQogICAgZWNobyAnIyEvYmluL3NoCgogICAgdHlwZSBnZXRhcmdzID4vZGV2L251bGwgMj4mMSB8fCAuIC9saWIvZHJhY3V0LWxpYi5zaAoKICAgICNjcHVtYXNrPSIkKGdldGFyZ3Mgbm9uX2lzb19jcHVtYXNrKSIKICAgIGNwdW1hc2s9JyRub25faXNvX2NwdW1hc2snCgogICAgbG9nKCkKICAgIHsKICAgIGVjaG8gInR1bmVkOiAkQCIgPj4gL2Rldi9rbXNnCiAgICB9CgogICAgaWYgWyAtbiAiJGNwdW1hc2siIF07IHRoZW4KICAgIGZvciBmaWxlIGluIC9zeXMvZGV2aWNlcy92aXJ0dWFsL3dvcmtxdWV1ZS9jcHVtYXNrIC9zeXMvYnVzL3dvcmtxdWV1ZS9kZXZpY2VzL3dyaXRlYmFjay9jcHVtYXNrOyBkbwogICAgICAgIGxvZyAic2V0dGluZyAkZmlsZSBDUFUgbWFzayB0byAkY3B1bWFzayIKICAgICAgICBpZiAhIGVjaG8gJGNwdW1hc2sgPiAkZmlsZSAyPi9kZXYvbnVsbDsgdGhlbgogICAgICAgIGxvZyAiRVJST1I6IGNvdWxkIG5vdCB3cml0ZSBDUFUgbWFzayBmb3IgJGZpbGUiCiAgICAgICAgZmkKICAgIGRvbmUKICAgIGZpJyA+IC4vdXNyL2xpYi9kcmFjdXQvaG9va3MvcHJlLXVkZXYvMDAtdHVuZWQtcHJlLXVkZXYuc2gKCiAgICAjIFNldCBDUFUgYWZmaW5pdHkgYWNjb3JkaW5nIHRvIHJlc2VydmVkX2NwdXMKICAgIGdldF9jcHVfYWZmaW5pdHkKICAgIGVjaG8gIltNYW5hZ2VyXSIgPj4gLi9ldGMvc3lzdGVtZC9zeXN0ZW0uY29uZgogICAgZWNobyAiQ1BVQWZmaW5pdHk9JGNwdV9hZmZpbml0eSIgPj4gLi9ldGMvc3lzdGVtZC9zeXN0ZW0uY29uZgoKICAgICMgU2V0IElSUSBiYW5uZWQgY3B1IGFjY29yZGluZyB0byByZXNlcnZlZF9jcHVzCiAgICBnZXRfY3B1X21hc2sgMAogICAgZWNobyAiSVJRQkFMQU5DRV9CQU5ORURfQ1BVUz0kbm9uX2lzb19jcHVtYXNrIiA+PiAuL2V0Yy9zeXNjb25maWcvaXJxYmFsYW5jZQogICAgCiAgICBmaW5kIC4gfCBjcGlvIC1jbyA+Li4vaXNvX2luaXRyZC5pbWcKICAgIGNkIC4uCiAgICBSSENPU19PU1RSRUVfUEFUSD0kKGxzIC10ZCAvYm9vdC9vc3RyZWUvKi8gfCBoZWFkIC0xKQogICAgY3AgaXNvX2luaXRyZC5pbWcgJFJIQ09TX09TVFJFRV9QQVRICiAgICBSSENPU19PU1RSRUVfUEFUSD0ke1JIQ09TX09TVFJFRV9QQVRIIyIvYm9vdCJ9CgogICAgIyBHZXQgY3VycmVudCBvc3RyZWUgY29uZmlnIGZpbGUKICAgIGN1cnJlbnRfdmVyPTEKICAgIGVudHJ5X2ZpbGU9JChscyAtdGQgL2Jvb3QvbG9hZGVyL2VudHJpZXMvKiB8IGhlYWQgLTEpCiAgICB3aGlsZSByZWFkIC1yIGxpbmUgOyBkbwogICAgICAgIHZlcj1gYXdrICcvdmVyc2lvbi8ge3ByaW50ICQyfScgJGxpbmVgCiAgICAgICAgaWYgWyAiJHZlciIgLWd0ICIkY3VycmVudF92ZXIiIF07IHRoZW4KICAgICAgICAgICBjdXJyZW50X3Zlcj0kdmVyCiAgICAgICAgICAgZW50cnlfZmlsZT0kbGluZQogICAgICAgIGZpCiAgICBkb25lIDw8PCQoZWdyZXAgJCh1bmFtZSAtcikgLWxyIC9ib290L2xvYWRlci9lbnRyaWVzLykKCiAgICBzZWQgLWkgInNeaW5pdHJkIC4qXCReJiAke1JIQ09TX09TVFJFRV9QQVRIfWlzb19pbml0cmQuaW1nXiIgJGVudHJ5X2ZpbGUKCiAgICAjVE9ETyAtIG9uY2UgUkhDT1MgaW1hZ2UgY29udGFpbnMgdGhlIGluaXRyZCBjb250ZW50IHdlIGNhbiBzZXQgcGFyYW1ldGVycyB3aXRoIHJwbS1vc3RyZWU6CiAgICAjcnBtLW9zdHJlZSBpbml0cmFtZnMgLS1lbmFibGUgLS1hcmc9LUkgLS1hcmc9L2V0Yy9zeXN0ZW1kL3N5c3RlbS5jb25mCiAgICAjcnBtLW9zdHJlZSBpbml0cmFtZnMgLS1lbmFibGUgLS1hcmc9LUkgLS1hcmc9L2V0Yy9zeXNjb25maWcvaXJxYmFsYW5jZQogICAgCiAgICBzeXN0ZW1jdGwgcmVib290CmZpCg==
        systemd:
            units:
                - contents: |
                      [Unit]
                      Description=Pre boot kernel tuning
                      Wants=rt-kernel.service
                      After=rt-kernel.service
                      Before=kubelet.service

                      [Service]
                      Type=exec
                      RemainAfterExit=true

                      ExecStart=/usr/local/bin/pre-boot-tuning.sh

                      [Install]
                      WantedBy=multi-user.target
                  enabled: true
                  name: pre-boot-tuning.service