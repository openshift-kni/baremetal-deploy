apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
    labels:
        machineconfiguration.openshift.io/role: worker-rt
    name: 12-rt-pre-boot-worker-tuning
spec:
    #kernelArguments:
    #    - 'non_iso_cpumask=00000005'
    #    - 'reserved_cpus'=0-2'
    config:
        ignition:
            config: {}
            security:
                tls: {}
            timeouts: {}
            version: 2.2.0
        networkd: {}
        passwd: {}
        storage:
            files:
                - filesystem: root
                  path: /usr/local/bin/pre-boot-tuning.sh
                  mode: 0700
                  contents:
                      source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpyZXNlcnZlZF9jcHVzPSIiCm5vbl9pc29fY3B1bWFzaz0iIgpjcHVfYWZmaW5pdHk9IiIKCmdldF9yZXNlcnZlZF9jb3JlcygpIHsKICAgIGNvcmVzPSgpCiAgICB3aGlsZSByZWFkIHBhcnQ7IGRvCiAgICAgICAgaWYgW1sgJHBhcnQgPX4gLSBdXTsgdGhlbgogICAgICAgICAgICBjb3Jlcys9KCQoc2VxICR7cGFydC8tLyB9KSkKICAgICAgICBlbHNlCiAgICAgICAgICAgIGNvcmVzKz0oJHBhcnQpCiAgICAgICAgZmkKICAgIGRvbmUgPCA8KCBlY2hvICRyZXNlcnZlZF9jcHVzIHwgdHIgJywnICdcbicgKQp9CgojICQxIC0gMCBmb3IgaXJxIGJhbGFuY2UgYmFubmVkIGNwdXMgbWFza2luZyAsIDEgZm9yIG5vbiBpc29sYXRlZCBjcHVzIG1hc2tpbmcKZ2V0X2NwdV9tYXNrKCkgewogICAgaWYgWyAiJDEiID0gIjEiIF07IHRoZW4KICAgICAgICBtYXNrPSggMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwICkKICAgIGVsc2UKICAgICAgICBtYXNrPSggMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxICkgCiAgICBmaSAgICAKICAgIGdldF9yZXNlcnZlZF9jb3JlcwogICAgZm9yIGNvcmUgaW4gJHtjb3Jlc1sqXX07IGRvCiAgICAgICAgZWNobyAkY29yZQogICAgICAgIG1hc2tbJGNvcmVdPSQxCiAgICBkb25lCiAgICBjcHVtYXNrQmluYXJ5PWBlY2hvICR7bWFza1tAXX18IHJldmAKICAgIGNwdW1hc2tCaW5hcnk9JHtjcHVtYXNrQmluYXJ5Ly9bWzpzcGFjZTpdXS99CiAgICBub25faXNvX2NwdW1hc2s9YHByaW50ZiAnJTA4eFxuJyAiJCgoMiMkY3B1bWFza0JpbmFyeSkpImAKfQoKZ2V0X2NwdV9hZmZpbml0eSgpIHsKICAgIGNwdV9hZmZpbml0eT0iIgogICAgZ2V0X3Jlc2VydmVkX2NvcmVzCiAgICBmb3IgY29yZSBpbiAke2NvcmVzWypdfTsgZG8KICAgICAgICBjcHVfYWZmaW5pdHkrPSIgJGNvcmUiCiAgICBkb25lCiAgICBlY2hvICJDUFUgQWZmaW5pdHkgc2V0IHRvICRjcHVfYWZmaW5pdHkiCn0KCiMgVE9ETzogaW1wcm92ZSBjaGVjayBmb3IgYXBwbGllZCBjb25maWd1cmF0aW9uCmlmIGdyZXAgLXEgIl5DUFVBZmZpbml0eSIgIi9ldGMvc3lzdGVtZC9zeXN0ZW0uY29uZiI7IHRoZW4KICAgIGVjaG8gIlByZSBib290IHR1bmluZyBjb25maWd1cmF0aW9uIGFscmVhZHkgYXBwbGllZCIKICAgIGVjaG8gIlNldHRpbmcga2VybmVsIHJjdW8qIHRocmVhZHMgdG8gdGhlIGhvdXNla2VlcGluZyBjcHVzIgogICAgZ2V0X2NwdV9tYXNrIDEKICAgIHBncmVwIHJjdW8qIHwgd2hpbGUgcmVhZCBsaW5lOyBkbyB0YXNrc2V0IC1wIG5vbl9pc29fY3B1bWFzayAkbGluZTsgZG9uZQplbHNlCiAgICBpZiBzeXNjdGwgLWEgfCBncmVwIC1xIHJlc2VydmVkX2NwdXM7IHRoZW4KICAgICAgICByZXNlcnZlZF9jcHVzPSIkKHN5c2N0bCAtcSAtZSAtbiByZXNlcnZlZF9jcHVzKSIKICAgIGVsc2UKICAgICAgICBlY2hvICJDb3VsZCBub3QgcmV0cml2ZSByZXNlcnZlZF9jcHVzIGZyb20ga2FyZ3MiCiAgICAgICAgZXhpdCAxICAgIAogICAgZmkKCiAgICAjIENsZWFuIHVwCiAgICBybSAtcmYgaW5pdHJkCiAgICBybSBpc29faW5pdHJkLmltZwogICAgIyBDcmVhdGUgaW5pdHJkIGltYWdlCiAgICBta2RpciBpbml0cmQKICAgIGNkIGluaXRyZAogICAgbWtkaXIgLXAgLi91c3IvbGliL2RyYWN1dC9ob29rcy9wcmUtdWRldi8KICAgIG1rZGlyIC1wIC4vZXRjL3N5c3RlbWQvCiAgICBta2RpciAtcCAuL2V0Yy9zeXNjb25maWcvCiAgICB0b3VjaCAuL2V0Yy9zeXN0ZW1kL3N5c3RlbS5jb25mCiAgICB0b3VjaCAuL2V0Yy9zeXNjb25maWcvaXJxYmFsYW5jZQogICAgdG91Y2ggLi91c3IvbGliL2RyYWN1dC9ob29rcy9wcmUtdWRldi8wMC10dW5lZC1wcmUtdWRldi5zaAogICAgY2htb2QgK3ggLi91c3IvbGliL2RyYWN1dC9ob29rcy9wcmUtdWRldi8wMC10dW5lZC1wcmUtdWRldi5zaAoKICAgIGdldF9jcHVfbWFzayAxCiAgICBlY2hvICcjIS9iaW4vc2gKCiAgICB0eXBlIGdldGFyZ3MgPi9kZXYvbnVsbCAyPiYxIHx8IC4gL2xpYi9kcmFjdXQtbGliLnNoCgogICAgI2NwdW1hc2s9IiQoZ2V0YXJncyBub25faXNvX2NwdW1hc2spIgogICAgY3B1bWFzaz0nJG5vbl9pc29fY3B1bWFzaycKCiAgICBsb2coKQogICAgewogICAgZWNobyAidHVuZWQ6ICRAIiA+PiAvZGV2L2ttc2cKICAgIH0KCiAgICBpZiBbIC1uICIkY3B1bWFzayIgXTsgdGhlbgogICAgZm9yIGZpbGUgaW4gL3N5cy9kZXZpY2VzL3ZpcnR1YWwvd29ya3F1ZXVlL2NwdW1hc2sgL3N5cy9idXMvd29ya3F1ZXVlL2RldmljZXMvd3JpdGViYWNrL2NwdW1hc2s7IGRvCiAgICAgICAgbG9nICJzZXR0aW5nICRmaWxlIENQVSBtYXNrIHRvICRjcHVtYXNrIgogICAgICAgIGlmICEgZWNobyAkY3B1bWFzayA+ICRmaWxlIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgbG9nICJFUlJPUjogY291bGQgbm90IHdyaXRlIENQVSBtYXNrIGZvciAkZmlsZSIKICAgICAgICBmaQogICAgZG9uZQogICAgZmknID4gLi91c3IvbGliL2RyYWN1dC9ob29rcy9wcmUtdWRldi8wMC10dW5lZC1wcmUtdWRldi5zaAoKICAgICMgU2V0IENQVSBhZmZpbml0eSBhY2NvcmRpbmcgdG8gcmVzZXJ2ZWRfY3B1cwogICAgZ2V0X2NwdV9hZmZpbml0eQogICAgZWNobyAiW01hbmFnZXJdIiA+PiAuL2V0Yy9zeXN0ZW1kL3N5c3RlbS5jb25mCiAgICBlY2hvICJDUFVBZmZpbml0eT0kY3B1X2FmZmluaXR5IiA+PiAuL2V0Yy9zeXN0ZW1kL3N5c3RlbS5jb25mCgogICAgIyBTZXQgSVJRIGJhbm5lZCBjcHUgYWNjb3JkaW5nIHRvIHJlc2VydmVkX2NwdXMKICAgIGdldF9jcHVfbWFzayAwCiAgICBlY2hvICJJUlFCQUxBTkNFX0JBTk5FRF9DUFVTPSRub25faXNvX2NwdW1hc2siID4+IC4vZXRjL3N5c2NvbmZpZy9pcnFiYWxhbmNlCiAgICAKICAgIGZpbmQgLiB8IGNwaW8gLWNvID4uLi9pc29faW5pdHJkLmltZwogICAgY2QgLi4KICAgIFJIQ09TX09TVFJFRV9QQVRIPSQobHMgLXRkIC9ib290L29zdHJlZS8qLyB8IGhlYWQgLTEpCiAgICBjcCBpc29faW5pdHJkLmltZyAkUkhDT1NfT1NUUkVFX1BBVEgKICAgIFJIQ09TX09TVFJFRV9QQVRIPSR7UkhDT1NfT1NUUkVFX1BBVEgjIi9ib290In0KCiAgICAjIEdldCBjdXJyZW50IG9zdHJlZSBjb25maWcgZmlsZQogICAgY3VycmVudF92ZXI9MQogICAgZW50cnlfZmlsZT0kKGxzIC10ZCAvYm9vdC9sb2FkZXIvZW50cmllcy8qIHwgaGVhZCAtMSkKICAgIHdoaWxlIHJlYWQgLXIgbGluZSA7IGRvCiAgICAgICAgdmVyPWBhd2sgJy92ZXJzaW9uLyB7cHJpbnQgJDJ9JyAkbGluZWAKICAgICAgICBpZiBbICIkdmVyIiAtZ3QgIiRjdXJyZW50X3ZlciIgXTsgdGhlbgogICAgICAgICAgIGN1cnJlbnRfdmVyPSR2ZXIKICAgICAgICAgICBlbnRyeV9maWxlPSRsaW5lCiAgICAgICAgZmkKICAgIGRvbmUgPDw8JChlZ3JlcCAkKHVuYW1lIC1yKSAtbHIgL2Jvb3QvbG9hZGVyL2VudHJpZXMvKQoKICAgIHNlZCAtaSAic15pbml0cmQgLipcJF4mICR7UkhDT1NfT1NUUkVFX1BBVEh9aXNvX2luaXRyZC5pbWdeIiAkZW50cnlfZmlsZQoKICAgICNUT0RPIC0gb25jZSBSSENPUyBpbWFnZSBjb250YWlucyB0aGUgaW5pdHJkIGNvbnRlbnQgd2UgY2FuIHNldCBwYXJhbWV0ZXJzIHdpdGggcnBtLW9zdHJlZToKICAgICNycG0tb3N0cmVlIGluaXRyYW1mcyAtLWVuYWJsZSAtLWFyZz0tSSAtLWFyZz0vZXRjL3N5c3RlbWQvc3lzdGVtLmNvbmYKICAgICNycG0tb3N0cmVlIGluaXRyYW1mcyAtLWVuYWJsZSAtLWFyZz0tSSAtLWFyZz0vZXRjL3N5c2NvbmZpZy9pcnFiYWxhbmNlCiAgICAKICAgIHN5c3RlbWN0bCByZWJvb3QKZmkK
        systemd:
            units:
                - contents: |
                      [Unit]
                      Description=Pre boot kernel tuning
                      Wants=rt-kernel.service
                      After=rt-kernel.service
                      Before=kubelet.service

                      [Service]
                      Type=exec
                      RemainAfterExit=true

                      ExecStart=/usr/local/bin/pre-boot-tuning.sh

                      [Install]
                      WantedBy=multi-user.target
                  enabled: true
                  name: pre-boot-tuning.service