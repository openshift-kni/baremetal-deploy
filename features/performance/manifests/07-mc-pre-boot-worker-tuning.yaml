apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
    labels:
        machineconfiguration.openshift.io/role: worker-rt
    name: 11-rt-kernel-worker-rt
spec:
    #kernelArguments:
    #    - 'non_iso_cpumask=00000005'
    config:
        ignition:
            config: {}
            security:
                tls: {}
            timeouts: {}
            version: 2.2.0
        networkd: {}
        passwd: {}
        storage:
            files:
                - filesystem: root
                  path: /usr/local/bin/pre-boot-tuning.sh
                  mode: 0700
                  contents:
                      source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpnZXRfcmVzZXJ2ZWRfY29yZXMoKSB7CiAgICBjb3Jlcz0oKQogICAgd2hpbGUgcmVhZCBwYXJ0OyBkbwogICAgICAgIGlmIFtbICRwYXJ0ID1+IC0gXV07IHRoZW4KICAgICAgICAgICAgY29yZXMrPSgkKHNlcSAke3BhcnQvLS8gfSkpCiAgICAgICAgZWxzZQogICAgICAgICAgICBjb3Jlcys9KCRwYXJ0KQogICAgICAgIGZpCiAgICBkb25lIDwgPCggZWNobyAkcmVzZXJ2ZWRfY3B1cyB8IHRyICcsJyAnXG4nICkKfQoKIyAkMSAtIDAgZm9yIGlycSBiYWxhbmNlIGJhbm5lZCBjcHVzIG1hc2tpbmcgLCAxIGZvciBub24gaXNvbGF0ZWQgY3B1cyBtYXNraW5nCmdldF9jcHVfbWFzaygpIHsKICAgIGlmIFsgIiQxIiA9ICIxIiBdOyB0aGVuCiAgICAgICAgbWFzaz0oIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCApCiAgICBlbHNlCiAgICAgICAgbWFzaz0oIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSAxIDEgMSApIAogICAgZmkgICAgCiAgICBnZXRfcmVzZXJ2ZWRfY29yZXMoKQogICAgZm9yIGNvcmUgaW4gJHtjb3Jlc1sqXX07IGRvCiAgICAgICAgZWNobyAkY29yZQogICAgICAgIG1hc2tbJGNvcmVdPSQxCiAgICBkb25lCiAgICBjcHVtYXNrQmluYXJ5PWBlY2hvICR7bWFza1tAXX18IHJldmAKICAgIGNwdW1hc2tCaW5hcnk9JHtjcHVtYXNrQmluYXJ5Ly9bWzpzcGFjZTpdXS99CiAgICBub25faXNvX2NwdW1hc2s9YHByaW50ZiAnJXhcbicgIiQoKDIjJGNwdW1hc2tCaW5hcnkpKSJgCn0KCmdldF9jcHVfYWZmaW5pdHkoKSB7CiAgICBjcHVfYWZmaW5pdHk9IiIKICAgIGdldF9yZXNlcnZlZF9jb3JlcygpCiAgICBmb3IgY29yZSBpbiAke2NvcmVzWypdfTsgZG8KICAgICAgICBjcHVfYWZmaW5pdHkrPSIgJGNvcmUiCiAgICBkb25lCn0KCiMgVE9ETzogaW1wcm92ZSBjaGVjayBmb3IgYXBwbGllZCBjb25maWd1cmF0aW9uCmlmIGdyZXAgLXEgIkNQVUFmZmluaXR5IiAiL2V0Yy9zeXN0ZW1kL3N5c3RlbS5jb25mIjsgdGhlbgogICAgZWNobyAiUHJlIGJvb3QgdHVuaW5nIGNvbmZpZ3VyYXRpb24gYWxyZWFkeSBhcHBsaWVkIgogICAgZWNobyAiU2V0dGluZyBrZXJuZWwgcmN1byogdGhyZWFkcyB0byB0aGUgaG91c2VrZWVwaW5nIGNwdXMiCiAgICBnZXRfY3B1X21hc2soKSAiMCIKICAgIHBncmVwIHJjdW8qIHwgd2hpbGUgcmVhZCBsaW5lOyBkbyB0YXNrc2V0IC1wIG5vbl9pc29fY3B1bWFzayAkbGluZTsgZG9uZQplbHNlCiAgICBpZiBzeXNjdGwgLWEgfCBncmVwIC1xIHJlc2VydmVkX2NwdXM7IHRoZW4KICAgICAgICByZXNlcnZlZF9jcHVzPSIkKHN5c2N0bCAtcSAtZSAtbiByZXNlcnZlZF9jcHVzKSIKICAgIGVsc2UKICAgICAgICBlY2hvICJDb3VsZCBub3QgcmV0cml2ZSByZXNlcnZlZF9jcHVzIGZyb20ga2FyZ3MiCiAgICAgICAgZXhpdCAxICAgIAogICAgZmkKCiAgICBta2RpciBpbml0cmQKICAgIGNkIGluaXRyZAogICAgY3BpbyAtaWR1bXYgPC4uL2lzb19pbml0cmQuaW1nCgogICAgIyBTZXQgQ1BVIGFmZmluaXR5IGFjY29yZGluZyB0byByZXNlcnZlZF9jcHVzCiAgICBlY2hvICJDUFVBZmZpbml0eT0kY3B1X2FmZmluaXR5IiA+PiBldGMvc3lzdGVtZC9zeXN0ZW0uY29uZgoKICAgICMgU2V0IElSUSBiYW5uZWQgY3B1IGFjY29yZGluZyB0byByZXNlcnZlZF9jcHVzCiAgICBnZXRfY3B1X21hc2soKSAiMCIKICAgIGVjaG8gIklSUUJBTEFOQ0VfQkFOTkVEX0NQVVM9JG5vbl9pc29fY3B1bWFzayIgPj4gZXRjL3N5c2NvbmZpZy9pcnFiYWxhbmNlCiAgICAKICAgIGZpbmQgLiB8IGNwaW8gLWNvID4uLi9pc29faW5pdHJkLmltZwogICAgY2QgLi4KICAgIFJIQ09TX09TVFJFRV9QQVRIPSQobHMgLXRkIC9ib290L29zdHJlZS8qLyB8IGhlYWQgLTEpCiAgICBjcCBpc29faW5pdHJkLmltZyAkUkhDT1NfT1NUUkVFX1BBVEgKICAgIFJIQ09TX09TVFJFRV9QQVRIPSR7UkhDT1NfT1NUUkVFX1BBVEgjIi9ib290In0KICAgIHNlZCAtaSAic15pbml0cmQgLipcJF4mICR7UkhDT1NfT1NUUkVFX1BBVEh9aXNvX2luaXRyZC5pbWdeIiAvYm9vdC9sb2FkZXIvZW50cmllcy9vc3RyZWUtMi1yaGNvcy5jb25mMgoKICAgICNUT0RPIC0gb25jZSBSSENPUyBpbWFnZSBjb250YWlucyB0aGUgaW5pdHJkIGNvbnRlbnQgd2UgY2FuIHNldCBwYXJhbWV0ZXJzIHdpdGggcnBtLW9zdHJlZToKICAgICNycG0tb3N0cmVlIGluaXRyYW1mcyAtLWVuYWJsZSAtLWFyZz0tSSAtLWFyZz0vZXRjL3N5c3RlbWQvc3lzdGVtLmNvbmYKICAgICNycG0tb3N0cmVlIGluaXRyYW1mcyAtLWVuYWJsZSAtLWFyZz0tSSAtLWFyZz0vZXRjL3N5c2NvbmZpZy9pcnFiYWxhbmNlCiAgICAKICAgIHN5c3RlbWN0bCByZWJvb3QKZmkK
        systemd:
            units:
                - contents: |
                      [Unit]
                      Description=Pre boot kernel tuning
                      Wants=rt-kernel.service
                      After=rt-kernel.service
                      Before=kubelet.service

                      [Service]
                      Type=exec
                      RemainAfterExit=true

                      ExecStart=/usr/local/bin/pre-boot-tuning.sh

                      [Install]
                      WantedBy=multi-user.target
                  enabled: true
                  name: pre-boot-tuning.service