---
- name: Power OFF nodes
  block:
    - name: Create list of hosts that are going to be powered off
      add_host:
        groups: poweroff_hosts
        hostname: "{{ item }}"
        inventory_dir: "{{ hostvars[item].inventory_dir }}"
      when: ( hostvars[item]['poweroff'] is not defined )
        or  ( hostvars[item]['poweroff']|bool | default(True) )
      with_items:
        - "{{ groups.masters }}"
        - "{{ groups.workers }}"
    
    - name: Power off hosts
      redfish_command:
        category: Systems
        command: PowerForceOff
        baseuri: "{{ hostvars[item]['ipmi_address'] }}"
        username: "{{ hostvars[item]['ipmi_user'] }}"
        password: "{{ hostvars[item]['ipmi_password'] }}"
      with_items: "{{ groups['poweroff_hosts'] }}"
  tags: powerservers
